# デジカメシャッター幕速測定用LED点滅切替装置
rollingShutterTester
https://github.com/citriena/rollingShutterTester

Copyright (C) 2023 by citriena

デジカメの幕速測定のためのLEDバー点滅を制御するArduinoスケッチです。
[デジカメシャッターの幕速測定装置](https://citriena.seesaa.net/article/rollingShutter.html)で使ったものです。


## 特徴
* 複数（コンパイル設定で 5，10，16本から選択可）のLEDバーを順に切替ながら点灯することで擬似的に横移動する被写体を作り出します。そのLEDバーを撮影することでデジカメのローリングシャッター幕速を調べることが出来ます。
* 切替速度はキーパッドで変更可能で、即座に反映されます。
* 点灯切替速度は0.01msecから200msec以上まで設定可能です。
 * 幕速が遅い電子シャッターのみならず、幕速が速い機械式シャッターも問題なく測定可能

## 使用ハードウェア
* Arduino: Arduino UNO R3
* LCD キーパッドシールド
 * 基本的にはアナログ式を使います。I2C式はアナログ式と比べてキーパッドの処理に時間がかかるため、切替速度が速い場合に制約がやや大きくなります。
* 制御用自作シールド
 * 単にArduinoのデジタルピン出力をトランジスタで増幅してLEDバーに供給しているだけです。
* LEDバー
 * それぞれ縦向きに平行に配置します。１本の長さはデジカメの画面内に縦いっぱいに撮影できるようにします。このため近距離で撮影するほど短くてすみます。
 * 電源はArduinoのVin（DCプラグ）から供給します。使用するArduinoの供給電圧範囲であれば問題ありませんが、12Vが選択肢も多く無難と思います。

## 操作方法
* キーパッドの上、下ボタンで点灯切替間隔を1msec、左右ボタンで0.1msec変更します。
 * 切替時間が1msec以下ではそれぞれ0.1msec, 0.01msecになります。
 * 切替時間が50msec以上ではそれぞれ10msec, 1msecになります。

## 動作
* 最初に左端のLEDバーが一定時間点灯後消灯し、その次のLEDバーが同様に一定時間点灯後消灯します。これを右端まで繰り返し後（１サイクル）、左端に戻って同じ処理を行います。すなわち、どの一瞬も点灯しているLEDバーは1本で、それが順に切り替わっていきます。
* 点灯バーが左端から右端に切り替わる時間も基本的には切替時間です。ただし、20サイクル（0.2msec以下では50サイクル）毎に、左端から右端に切り替わるときにキーパッド読出し処理を行います。0.2msec以上では切替時間内にキーパッド読出し処理が完了しますので切替時間は設定時間のままですが、0.2msec以下では設定時間内にキーパッド読出し処理が終わりませんので約１サイクル分消灯したままとし、次のサイクルから点灯を再開します。

### 補足
* 点灯時間の制御はループ内でmicros()を監視し、設定時間を超えたら点灯、消灯を制御しています。1回のループには実測で約3.8usec (0.0038msec)かかっていますので、誤差は最大0.0038msecです（切替時間0.2msでは誤差最大1.6%）。0.2msec以下ではdelayMicroseconds()を併用することで誤差を小さくしており、0.01msecでも誤差は5%程度に収まっています。そもそも一般的なデジカメのシャッター幕速はメカシャッターでも数msecですので問題ない誤差かと思います。
 * 20サイクルもしくは50サイクル毎にキーパッド処理時間のために１サイクル分消灯する境界は0.2msec固定ではなく、処理が間に合っているかどうか実行中に判定しています。
 * 切替時間が2msec以上の場合は時間に余裕がありますし、10msec以上になると20サイクル待っていたら反応が遅いので、点灯切替毎にキーパッド読み取り処理を行います。

## 撮影と解析方法
* デジカメでLEDバーを画面全体に入れて撮影します。上下は多少切れてもかまいませんのでいっぱいに入れます。シャッター速度は後述の理由により、なるべく速いほうが解析が容易です。私は最高速で撮影しています。
* 露出は、LEDの点灯がわかりやすいように調節します。一般的には背景が明るくならない範囲で上げるのが良いでしょう。
* 幕速を解析するにはLED点灯切替時間が幕速よりも短い必要があります。幕速と同程度だと解析可能な画像が得られる確率が低いので、幕速の数倍～20倍程度が良いと思います。切替時間を変えて撮影し、適切な切替時間を選定してください。
* グローバシャッターなら点滅速度をどんなに速くしても次のように1本のバーは全体が写るか全く写らないかです。点滅速度とタイミングによっては複数本写る可能性もあります。その場合でもLEDバーは全体が写るはずです。

```
（|は消灯、＊は点灯）
|       |       *       |       |
|       |       *       |       |
|       |       *       |       |
|       |       *       |       |
|       |       *       |       |
|       |       *       |       |
|       |       *       |       |
|       |       *       |       |
|       |       *       |       |
|       |       *       |       |
```
* 一方ローリングシャッターでは点灯切替時間が幕速よりも短ければLEDバーの一部しか写らなくなります。その写り方から幕速を計算できます。
たとえば、点灯切替時間10msecで次のように写ったとします。

```
（|は消灯、＊は点灯）
|       *       |       |       |
|       |       *       |       |
|       |       *       |       |
|       |       *       |       |
|       |       |       *       |
|       |       |       *       |
|       |       |       *       |
|       |       |       |       *
|       |       |       |       *
|       |       |       |       *
```
* 上の図では列が切り替わる10msecで上下の3/10移動していますので、幕速は10msec ÷ 3/10 = 33.3msecとなります。
もしくは、３本先のバー(30msec)までで上下の9/10移動していますので、幕速は10msec × 3 ÷ 9/10 = 33.3msecとなります。
* 撮影方法は異なりますが基本的な考え方は同じなので、[この解析方法](https://youtu.be/e9n7sV4HVkI)が使えます。
* 機械式シャッターの場合は幕の移動速度が一定ではありませんので（最初遅く、後半速くなる）、なるべく画面の上下両端で判定する必要があります。
* 上の図ではLEDバーの左端から右端までの１巡内で解析できていますが、例えば次の図の様に左端に戻ってきていても幕速の解析に問題なく使えます。

```
（|は消灯、＊は点灯）
|       |       |       *       |
|       |       |       |       *
|       |       |       |       *
|       |       |       |       *
*       |       |       |       |
*       |       |       |       |
*       |       |       |       |
|       *       |       |       |
|       *       |       |       |
|       *       |       |       |
```
* なお、隣り合うバーの重なる幅が先幕と後幕のスリット幅です。シャッタースピードを速くするほど狭くなります。上の例は高速のシャッター速度（1/16000秒など）での撮影時で、スリット幅が狭いので隣り合うバーの重なりはほとんどありません。
* 一方シャッター速度を例えば1/200秒と遅くすると、同じ点灯切替速度の10msecでも次のように写ります。重なっている部分は全体の5/10なので、10msec × 5/10 = 5msec = 1/200秒です。

```
（|は消灯、＊は点灯）
|       *       |       |       |
|       *       *       |       |
|       *       *       |       |
|       *       *       |       |
|       *       *       *       |
|       *       *       *       |
|       |       *       *       |
|       |       *       *       *
|       |       *       *       *
|       |       |       *       *
```
* 図では示せませんが、重なっている部分は端に近いほど暗く写ります。具体的な状況は[デジカメシャッターの幕速測定装置](https://citriena.seesaa.net/article/rollingShutter.html)の機械式シャッターの撮影例を参照してください。このため、シャッター速度が遅いと点灯しているLEDの端がわかりにくくなるので、シャッター速度はなるべく速いほうが良いと思います。
* 実際の撮影画像は[デジカメシャッターの幕速測定装置](https://citriena.seesaa.net/article/rollingShutter.html)を見てください。

## 本資料について
* 本資料の内容は無保証です。

## Releases
### 1.0.0 - Jan. 31, 2023
